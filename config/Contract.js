const { WS_RPC } = require('@vite/vitejs-ws');
const {
	ViteAPI,
	wallet,
	utils,
	abi,
	accountBlock,
	keystore,
} = require('@vite/vitejs');
const { ethers } = require('ethers');
const { eth } = require('web3');

// test account
const seed =
	'renew weekend staff goat assume inmate dash hello popular potato talent area vibrant reopen cluster';

// connect to node
const connection = new WS_RPC('wss://buidl.vite.net/gvite/ws');
const provider = new ViteAPI(connection, () => {
	console.log('client connected');
});
const tokenId = 'tti_d14e8c24a5ba2d98fae2c152';

// derive account from seed phrase
const myAccount = wallet.getWallet(seed).deriveAddress(0);

// fill in contract info
const CONTRACT = {
	binary:
		'608060405269d14e8c24a5ba2d98fae26000806101000a81548169ffffffffffffffffffff021916908369ffffffffffffffffffff16021790555034801561004657600080fd5b50336000600a6101000a81548174ffffffffffffffffffffffffffffffffffffffffff021916908374ffffffffffffffffffffffffffffffffffffffffff160217905550610ead806100996000396000f3fe608060405261051e565b60016020528060005260406000216000915090505481565b600081319050919050565b6000600a9054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1681565b8160008054906101000a900469ffffffffffffffffffff163110156100ad576040517f4b2bae7e0000000000000000000000000000000000000000000000000000000081526004016100a490610a93565b60405180910390fd5b3374ffffffffffffffffffffffffffffffffffffffffff166000600a9054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff1614610140576040517f4b2bae7e00000000000000000000000000000000000000000000000000000000815260040161013790610a53565b60405180910390fd5b8074ffffffffffffffffffffffffffffffffffffffffff168369ffffffffffffffffffff16836040516000604051905080820390838587f150505050505050565b80518251146101c5576040517f4b2bae7e0000000000000000000000000000000000000000000000000000000081526004016101bc90610ab3565b60405180910390fd5b6000600a9054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff163374ffffffffffffffffffffffffffffffffffffffffff1614610258576040517f4b2bae7e00000000000000000000000000000000000000000000000000000000815260040161024f90610a33565b60405180910390fd5b6000805b82518110156102c65782818151811061029e577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151826102b19190610b7c565b915080806102be90610c7a565b91505061025c565b50808431101561030b576040517f4b2bae7e00000000000000000000000000000000000000000000000000000000815260040161030290610a73565b60405180910390fd5b60005b835181101561051757838181518110610350577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015174ffffffffffffffffffffffffffffffffffffffffff168569ffffffffffffffffffff168483815181106103b5577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516040516000604051905080820390838587f15050505082818151811061040c577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160016000868481518110610451577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015174ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002160008282546104a49190610b7c565b925050819055508281815181106104e4577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151600260008282546104fd9190610b7c565b92505081905550808061050f90610c7a565b91505061030e565b5050505050565b600436106105685760003560e01c80632b10ff65146105af5780632e87cfe8146105df578063336139331461060f5780639e488b3c1461062d578063a3a7907714610649576105aa565b366105aa577ff60b91d6d66b14659a13ae6c1839bbd5a5f36193f26636372555194d233430003346346040516105a0939291906109fc565b60405180910390a1005b600080fd5b6105c960048036038101906105c491906107e5565b610009565b6040516105d69190610ad3565b60405180910390f35b6105f960048036038101906105f4919061080e565b610021565b6040516106069190610ad3565b60405180910390f35b61061761002c565b60405161062491906109e1565b60405180910390f35b610647600480360381019061064291906108b6565b610053565b005b610663600480360381019061065e9190610837565b610181565b005b600061067861067384610b13565b610aee565b9050808382526020820190508285602086028201111561069757600080fd5b60005b858110156106c757816106ad8882610752565b84526020840193506020830192505060018101905061069a565b5050509392505050565b60006106e46106df84610b3f565b610aee565b9050808382526020820190508285602086028201111561070357600080fd5b60005b85811015610733578161071988826107d0565b845260208401935060208301925050600181019050610706565b5050509392505050565b60008135905061074c81610e25565b92915050565b60008135905061076181610e3c565b92915050565b600082601f83011261077857600080fd5b8135610788848260208601610665565b91505092915050565b600082601f8301126107a257600080fd5b81356107b28482602086016106d1565b91505092915050565b6000813590506107ca81610e53565b92915050565b6000813590506107df81610e6a565b92915050565b6000602082840312156107f757600080fd5b60006108058482850161073d565b91505092915050565b60006020828403121561082057600080fd5b600061082e848285016107bb565b91505092915050565b60008060006060848603121561084c57600080fd5b600061085a868287016107bb565b935050602084013567ffffffffffffffff81111561087757600080fd5b61088386828701610767565b925050604084013567ffffffffffffffff8111156108a057600080fd5b6108ac86828701610791565b9150509250925092565b6000806000606084860312156108cb57600080fd5b60006108d9868287016107bb565b93505060206108ea868287016107d0565b92505060406108fb86828701610752565b9150509250925092565b61090e81610bd2565b82525050565b6000610921601783610b6b565b915061092c82610d32565b602082019050919050565b6000610944601783610b6b565b915061094f82610d5b565b602082019050919050565b6000610967601e83610b6b565b915061097282610d84565b602082019050919050565b600061098a601283610b6b565b915061099582610dad565b602082019050919050565b60006109ad602e83610b6b565b91506109b882610dd6565b604082019050919050565b6109cc81610bf6565b82525050565b6109db81610c29565b82525050565b60006020820190506109f66000830184610905565b92915050565b6000606082019050610a116000830186610905565b610a1e60208301856109c3565b610a2b60408301846109d2565b949350505050565b60006020820190508181036000830152610a4c81610914565b9050919050565b60006020820190508181036000830152610a6c81610937565b9050919050565b60006020820190508181036000830152610a8c8161095a565b9050919050565b60006020820190508181036000830152610aac8161097d565b9050919050565b60006020820190508181036000830152610acc816109a0565b9050919050565b6000602082019050610ae860008301846109d2565b92915050565b6000610af8610b09565b9050610b048282610c49565b919050565b6000604051905090565b600067ffffffffffffffff821115610b2e57610b2d610cf2565b5b602082029050602081019050919050565b600067ffffffffffffffff821115610b5a57610b59610cf2565b5b602082029050602081019050919050565b600082825260208201905092915050565b6000610b8782610c29565b9150610b9283610c29565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610bc757610bc6610cc3565b5b828201905092915050565b6000610bdd82610c08565b9050919050565b6000610bef82610c08565b9050919050565b6000610c0182610c33565b9050919050565b600074ffffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600069ffffffffffffffffffff82169050919050565b610c5282610d21565b810181811067ffffffffffffffff82111715610c7157610c70610cf2565b5b80604052505050565b6000610c8582610c29565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610cb857610cb7610cc3565b5b600182019050919050565b7fe0f8f85500000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7fe0f8f85500000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b7f43616c6c6572206973206e6f7420746865206f776e6572000000000000000000600082015250565b7f43616c6c6572206973206e6f7420746865204f776e6572000000000000000000600082015250565b7f446f6e74206861766520656e6f75676820657468657220746f2073656e640000600082015250565b7f4f7574206f662042616c616e6365204e6f770000000000000000000000000000600082015250565b7f41646472657373657320417272617920616e6420416d6f756e7420417272617960008201527f20617265206e6f7420657175616c000000000000000000000000000000000000602082015250565b610e2e81610bd2565b8114610e3957600080fd5b50565b610e4581610be4565b8114610e5057600080fd5b50565b610e5c81610bf6565b8114610e6757600080fd5b50565b610e7381610c29565b8114610e7e57600080fd5b5056fea165627a7a7230582000000000000000000000000000000000000000000000000000000000000000000029', // binary code
	abi: [
		{ inputs: [], stateMutability: 'nonpayable', type: 'constructor' },
		{
			anonymous: false,
			inputs: [
				{
					indexed: false,
					internalType: 'address',
					name: 'sender',
					type: 'address',
				},
				{
					indexed: false,
					internalType: 'tokenId',
					name: 'token',
					type: 'tokenId',
				},
				{
					indexed: false,
					internalType: 'uint256',
					name: 'amount',
					type: 'uint256',
				},
			],
			name: 'Received',
			type: 'event',
		},
		{
			inputs: [
				{ internalType: 'tokenId', name: 'tokenId', type: 'tokenId' },
				{
					internalType: 'address payable[]',
					name: '_addresses',
					type: 'address[]',
				},
				{ internalType: 'uint256[]', name: 'amount', type: 'uint256[]' },
			],
			name: 'distributeReward',
			outputs: [],
			stateMutability: 'payable',
			type: 'function',
		},
		{
			inputs: [{ internalType: 'tokenId', name: 'tokenId', type: 'tokenId' }],
			name: 'getBalance',
			outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
			stateMutability: 'view',
			type: 'function',
		},
		{
			inputs: [],
			name: 'owner',
			outputs: [{ internalType: 'address', name: '', type: 'address' }],
			stateMutability: 'view',
			type: 'function',
		},
		{
			inputs: [{ internalType: 'address', name: '', type: 'address' }],
			name: 'rewardReceived',
			outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
			stateMutability: 'view',
			type: 'function',
		},
		{
			inputs: [
				{ internalType: 'tokenId', name: 'tokenId', type: 'tokenId' },
				{ internalType: 'uint256', name: 'amount', type: 'uint256' },
				{
					internalType: 'address payable',
					name: 'receiveAddress',
					type: 'address',
				},
			],
			name: 'withDrawToken',
			outputs: [],
			stateMutability: 'nonpayable',
			type: 'function',
		},
		{ stateMutability: 'payable', type: 'receive' },
	], // JSON ABI
	// JSON ABI

	offChain:
		'608060405269d14e8c24a5ba2d98fae26000806101000a81548169ffffffffffffffffffff021916908369ffffffffffffffffffff16021790555034801561004657600080fd5b50336000600a6101000a81548174ffffffffffffffffffffffffffffffffffffffffff021916908374ffffffffffffffffffffffffffffffffffffffffff160217905550610ead806100996000396000f3fe608060405261051e565b60016020528060005260406000216000915090505481565b600081319050919050565b6000600a9054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1681565b8160008054906101000a900469ffffffffffffffffffff163110156100ad576040517f4b2bae7e0000000000000000000000000000000000000000000000000000000081526004016100a490610a93565b60405180910390fd5b3374ffffffffffffffffffffffffffffffffffffffffff166000600a9054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff1614610140576040517f4b2bae7e00000000000000000000000000000000000000000000000000000000815260040161013790610a53565b60405180910390fd5b8074ffffffffffffffffffffffffffffffffffffffffff168369ffffffffffffffffffff16836040516000604051905080820390838587f150505050505050565b80518251146101c5576040517f4b2bae7e0000000000000000000000000000000000000000000000000000000081526004016101bc90610ab3565b60405180910390fd5b6000600a9054906101000a900474ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff163374ffffffffffffffffffffffffffffffffffffffffff1614610258576040517f4b2bae7e00000000000000000000000000000000000000000000000000000000815260040161024f90610a33565b60405180910390fd5b6000805b82518110156102c65782818151811061029e577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151826102b19190610b7c565b915080806102be90610c7a565b91505061025c565b50808431101561030b576040517f4b2bae7e00000000000000000000000000000000000000000000000000000000815260040161030290610a73565b60405180910390fd5b60005b835181101561051757838181518110610350577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015174ffffffffffffffffffffffffffffffffffffffffff168569ffffffffffffffffffff168483815181106103b5577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516040516000604051905080820390838587f15050505082818151811061040c577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160016000868481518110610451577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015174ffffffffffffffffffffffffffffffffffffffffff1674ffffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002160008282546104a49190610b7c565b925050819055508281815181106104e4577fe0f8f85500000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151600260008282546104fd9190610b7c565b92505081905550808061050f90610c7a565b91505061030e565b5050505050565b600436106105685760003560e01c80632b10ff65146105af5780632e87cfe8146105df578063336139331461060f5780639e488b3c1461062d578063a3a7907714610649576105aa565b366105aa577ff60b91d6d66b14659a13ae6c1839bbd5a5f36193f26636372555194d233430003346346040516105a0939291906109fc565b60405180910390a1005b600080fd5b6105c960048036038101906105c491906107e5565b610009565b6040516105d69190610ad3565b60405180910390f35b6105f960048036038101906105f4919061080e565b610021565b6040516106069190610ad3565b60405180910390f35b61061761002c565b60405161062491906109e1565b60405180910390f35b610647600480360381019061064291906108b6565b610053565b005b610663600480360381019061065e9190610837565b610181565b005b600061067861067384610b13565b610aee565b9050808382526020820190508285602086028201111561069757600080fd5b60005b858110156106c757816106ad8882610752565b84526020840193506020830192505060018101905061069a565b5050509392505050565b60006106e46106df84610b3f565b610aee565b9050808382526020820190508285602086028201111561070357600080fd5b60005b85811015610733578161071988826107d0565b845260208401935060208301925050600181019050610706565b5050509392505050565b60008135905061074c81610e25565b92915050565b60008135905061076181610e3c565b92915050565b600082601f83011261077857600080fd5b8135610788848260208601610665565b91505092915050565b600082601f8301126107a257600080fd5b81356107b28482602086016106d1565b91505092915050565b6000813590506107ca81610e53565b92915050565b6000813590506107df81610e6a565b92915050565b6000602082840312156107f757600080fd5b60006108058482850161073d565b91505092915050565b60006020828403121561082057600080fd5b600061082e848285016107bb565b91505092915050565b60008060006060848603121561084c57600080fd5b600061085a868287016107bb565b935050602084013567ffffffffffffffff81111561087757600080fd5b61088386828701610767565b925050604084013567ffffffffffffffff8111156108a057600080fd5b6108ac86828701610791565b9150509250925092565b6000806000606084860312156108cb57600080fd5b60006108d9868287016107bb565b93505060206108ea868287016107d0565b92505060406108fb86828701610752565b9150509250925092565b61090e81610bd2565b82525050565b6000610921601783610b6b565b915061092c82610d32565b602082019050919050565b6000610944601783610b6b565b915061094f82610d5b565b602082019050919050565b6000610967601e83610b6b565b915061097282610d84565b602082019050919050565b600061098a601283610b6b565b915061099582610dad565b602082019050919050565b60006109ad602e83610b6b565b91506109b882610dd6565b604082019050919050565b6109cc81610bf6565b82525050565b6109db81610c29565b82525050565b60006020820190506109f66000830184610905565b92915050565b6000606082019050610a116000830186610905565b610a1e60208301856109c3565b610a2b60408301846109d2565b949350505050565b60006020820190508181036000830152610a4c81610914565b9050919050565b60006020820190508181036000830152610a6c81610937565b9050919050565b60006020820190508181036000830152610a8c8161095a565b9050919050565b60006020820190508181036000830152610aac8161097d565b9050919050565b60006020820190508181036000830152610acc816109a0565b9050919050565b6000602082019050610ae860008301846109d2565b92915050565b6000610af8610b09565b9050610b048282610c49565b919050565b6000604051905090565b600067ffffffffffffffff821115610b2e57610b2d610cf2565b5b602082029050602081019050919050565b600067ffffffffffffffff821115610b5a57610b59610cf2565b5b602082029050602081019050919050565b600082825260208201905092915050565b6000610b8782610c29565b9150610b9283610c29565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610bc757610bc6610cc3565b5b828201905092915050565b6000610bdd82610c08565b9050919050565b6000610bef82610c08565b9050919050565b6000610c0182610c33565b9050919050565b600074ffffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600069ffffffffffffffffffff82169050919050565b610c5282610d21565b810181811067ffffffffffffffff82111715610c7157610c70610cf2565b5b80604052505050565b6000610c8582610c29565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610cb857610cb7610cc3565b5b600182019050919050565b7fe0f8f85500000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7fe0f8f85500000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b7f43616c6c6572206973206e6f7420746865206f776e6572000000000000000000600082015250565b7f43616c6c6572206973206e6f7420746865204f776e6572000000000000000000600082015250565b7f446f6e74206861766520656e6f75676820657468657220746f2073656e640000600082015250565b7f4f7574206f662042616c616e6365204e6f770000000000000000000000000000600082015250565b7f41646472657373657320417272617920616e6420416d6f756e7420417272617960008201527f20617265206e6f7420657175616c000000000000000000000000000000000000602082015250565b610e2e81610bd2565b8114610e3957600080fd5b50565b610e4581610be4565b8114610e5057600080fd5b50565b610e5c81610bf6565b8114610e6757600080fd5b50565b610e7381610c29565b8114610e7e57600080fd5b5056fea165627a7a7230582000000000000000000000000000000000000000000000000000000000000000000029', // binary offchain code
	address: 'vite_6de42dbda0f954f126f9c85bf2c16d9e31c7d2fff7a1204ff3', // contract address
};

CONTRACT.address = 'vite_6de42dbda0f954f126f9c85bf2c16d9e31c7d2fff7a1204ff3';

async function callContract(account, methodName, abi, params, amount) {
	const block = accountBlock
		.createAccountBlock('callContract', {
			address: account.address,
			abi,
			methodName,
			amount,
			toAddress: CONTRACT.address,
			params,
		})
		.setProvider(provider)
		.setPrivateKey(account.privateKey);

	await block.autoSetPreviousAccountBlock();
	const result = await block.sign().send();
	console.log('call success', result);
}
//get balance of this contract by calling the function
exports.getBalance = async () =>{
	const tokenId = 'tti_d14e8c24a5ba2d98fae2c152';
	let contractBalance;
	await provider
		.getBalanceInfo('vite_6de42dbda0f954f126f9c85bf2c16d9e31c7d2fff7a1204ff3')
		.then(({ balance }) => {
			contractBalance = balance.balanceInfoMap[tokenId].balance;
		})
		.catch(err => {
			console.warn(err);
		});

	const centBalance = ethers.formatEther(contractBalance);
	console.log(centBalance);
	return centBalance;
}

//array of addresses
const receipient = [
	'vite_1d15e2ed07e2ea6fc9432729b85508f543ed1d6f616b6587ac',
	'vite_914c2b3bba96113b2321b8f475f95c8eb3f15fee2b73a733ad',
];
//array of amount
const amount = ['150000000000000000000', '150000000000000000000'];

//send money to account address by calling this function
exports.main = async (receipient,amount)=> {
  console.log({receipient,amount})
	// call the contract we deployed and send over 150 VITE
	await callContract(myAccount, 'distributeReward', CONTRACT.abi, [
		tokenId,
		receipient,
		amount,
	]);
}
